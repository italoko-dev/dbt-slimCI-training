name: dbt-slimCI
run-name: pull-requests workflow
on:
  pull_request:
    branches:
      - dev
jobs:
  pull-requests:
    runs-on: ubuntu-latest
    
    steps: 
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '>=3.12'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          cd dbt_slimCI
          dbt deps
      
      - name: LINT - Checkout source branch and diff quality
        run:  |
          cd dbt_slimCI
          sqlfluff lint models --dialect=postgres
        continue-on-error: true
        # git checkout ${{ github.head_ref }}
        # cd dbt_slimCI
        # diff-quality --violations=sqlfluff --fail-under=95 --compare-branch=origin/dev
      
      # Here we'll simulate the download artifact dbt from develop to comparison in the next step.
      - name: SIMULATION - Download develop dbt artifact    
        run: echo 'Download of the last manifest.json from develop'

      # Here we'll simulate the dbt run
      # To simulate, we'll use 'dbt ls' command to list models should be executed.
      # NOTE: The static file './old-target/manifest.json' was runned only model_1.
      - name: SIMULATION - dbt Run all files with state modified+ 
        run: |
          cd dbt_slimCI
          dbt ls -s state:modified+ --state ..\old-target --profile prd --defer
        #dbt run -s state:modified+ --state ..\old-target --profile prd --defer
      
      - name: SIMULATION - dbt test all files with state modified+    
        run: echo 'Download of the last manifest.json from develop'
